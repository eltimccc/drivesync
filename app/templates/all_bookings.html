{% extends 'base.html' %}

{% block title %}Бронирования{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/styles.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h4 class="text-center">Бронирования</h4>

  <!-- Фильтр над правой частью таблицы -->
  <div class="row justify-content-end mb-3">
    <div class="col-md-4">
      <form id="filterForm" method="GET" action="{{ url_for('main.get_bookings') }}">
        <div class="input-group">
          <input
            type="text"
            name="filter"
            id="filterInput"
            placeholder="Текст для фильтра"
            class="form-control"
            value="{{ filter }}"
          />
          <select id="statusFilter" class="form-select ms-2">
            <option value="">Все статусы</option>
            {% for status, color in BOOKING_STATUSES.items() %}
            <option value="{{ status }}">{{ status }}</option>
            {% endfor %}
          </select>
        </div>
      </form>
    </div>
  </div>

  <div class="table-container">
    <div class="fixed-header">
      <table class="table table-hover">
        <thead class="table-dark">
          <tr>
            <th></th>
            <th data-sort="id">ID</th>
            <th data-sort="car_id">Автомобиль</th>
            <th data-sort="transmission">КПП</th>
            <th data-sort="car_number">Гос. номер</th>
            <th data-sort="start_date">Дата начала</th>
            <th data-sort="end_date">Дата окончания</th>
            <th data-sort="phone">Телефон</th>
            <th data-sort="description">Заметка</th>
            <th data-sort="user_id">Добавил</th>
          </tr>
        </thead>
        <tbody>
          {% for booking in bookings %}
          <tr
            id="booking-{{ booking.id }}"
            class="status-{{ booking.status | lower }}"
            onclick="openBookingModal({{ booking.id }}, this.getAttribute('data-url'))"
            data-url="{{ url_for('booking.view_booking_modal', booking_id=booking.id) }}"
          >
            <td
              class="{% if booking.start_date.date() == today %}status-pickup-cell{% elif booking.end_date.date() == today %}status-dropoff-cell{% endif %}"
            ></td>
            <td>{{ booking.id }}</td>
            <td>{{ booking.car.brand }}</td>
            <td>{{ booking.car.transmission }}</td>
            <td>{{ booking.car.car_number }}</td>
            <td>{{ booking.start_date.strftime('%d.%m.%y %H:%M') }}</td>
            <td>{{ booking.end_date.strftime('%d.%m.%y %H:%M') }}</td>
            <td>{{ booking.phone }}</td>
            <td>
              {{ booking.description[:20] }}{% if booking.description|length >
              20 %}...{% endif %}
            </td>
            <td>{{ booking.user.username }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Модальное окно для бронирования -->
<div
  class="modal fade"
  id="bookingModal"
  tabindex="-1"
  aria-labelledby="bookingModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body">
        <div id="modal-content-placeholder">Загрузка...</div>
      </div>
    </div>
  </div>
</div>

<!-- Кастомное модальное окно для удаления -->
<div
  id="custom-confirm-modal"
  class="custom-confirm-modal"
  style="display: none"
>
  <div class="custom-modal-content">
    <p>Вы уверены, что хотите удалить это бронирование?</p>
    <form id="delete-form" method="post">
      <button type="button" id="confirm-ok-button" class="btn btn-success">
        OK
      </button>
      <button
        type="button"
        id="confirm-cancel-button"
        class="btn btn-secondary"
      >
        Отмена
      </button>
    </form>
  </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script src="{{ url_for('static', filename='js/all_booking_filter.js') }}"></script>
<script src="{{ url_for('static', filename='js/all_booking_modal.js') }}"></script>
<script src="{{ url_for('static', filename='js/table_sort_booking.js') }}"></script>
{% endblock %}
